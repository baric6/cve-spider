const request = require('request')
const cheerio = require('cheerio')
const express = require('express')
const schedule = require('node-schedule')
const firebaseAdmin = require('firebase-admin')




const PORT = process.env.PORT || 5000
const app = express()
const run = app.listen(PORT, () => console.log("Server is listening to port " + PORT))

// since this is a absolute path need to change when i put on my server
var serviceAccount = require("");
firebaseAdmin.initializeApp({
    credential: firebaseAdmin.credential.cert(serviceAccount),
    databaseURL: ""
  });
  
//grabs one extra tag very @ cves[0] need to delete
const webpages = ['https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&search_type=all&isCpeNameSearch=false',
'https://nvd.nist.gov/vuln/search/results?isCpeNameSearch=false&results_type=overview&form_type=Basic&search_type=all&startIndex=20']

var getHtmldata = ((webpage) =>{

        request(webpage, 
            (err, res, htmlData)=>{
        
                if(!err && res.statusCode == 200){
        
                    const $ = cheerio.load(htmlData)
        
                    //get data out of the html using classes
                    $("tr", htmlData).each((index, element) => {
                        //console.log(element)
                        if(index != 0){
                            const title = $(element).find("th").text()
                            const dis = $(element).find("p").text()
                            const released = $(element).find("span").text().replace(/\t/g,"").split("\n")[0]
        
                            const urlprefix = "https://nvd.nist.gov"
                            const urlendfix = $(element).find("a").attr("href")
                            const url = urlprefix + urlendfix
        
                            saveToFirebase(title, dis, released, url)
                        }
                        
                    })
                }
                else{
                    console.log('errored out')
                }
            })

    
})

var saveToFirebase = ((cve, dis, released, url)=>{
    var db = firebaseAdmin.database()
    var ref = db.ref("");

    const cveRef = ref.child(cve);
    cveRef.set({
        cve: {
        cveName: cve,
        cveDis: dis,
        cveDate: released,
        cveUrl: url
        }}, 
        function(error){
            if(error){
                console.log(error)
                console.log("broke at " + cve)
            }
            else{
                console.log(cve + " has been saved to firebase")
            }
        }    
    )    

})

//getHtmldata()

//uncomment when ready to put on a schedual
// runs every 8 hours of the day
// 0 */8 * * * 
// every second min
// */2 * * * *

//                             runs every 6 hours
const job = schedule.scheduleJob('0 */6 * * *', function(){
    getHtmldata('https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&search_type=all&isCpeNameSearch=false')
    getHtmldata('https://nvd.nist.gov/vuln/search/results?isCpeNameSearch=false&results_type=overview&form_type=Basic&search_type=all&startIndex=20')
        console.log("job ran: " + new Date().toLocaleString())
  });



